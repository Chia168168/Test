<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Base64 圖片轉換工具 - 增強版</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-bg: #ecf0f1;
            --dark-text: #2c3e50;
            --light-text: #7f8c8d;
            --card-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: var(--dark-text);
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px;
            background: white;
            border-radius: 15px;
            box-shadow: var(--card-shadow);
            position: relative;
            overflow: hidden;
        }
        
        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, var(--primary-color), var(--success-color));
        }
        
        h1 {
            color: var(--secondary-color);
            margin-bottom: 10px;
            font-size: 2.8rem;
            font-weight: 700;
        }
        
        .subtitle {
            color: var(--light-text);
            font-size: 1.3rem;
            margin-bottom: 15px;
        }
        
        .version {
            background: var(--primary-color);
            color: white;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: inline-block;
            margin-left: 10px;
        }
        
        .tool-description {
            margin: 15px 0;
            color: var(--light-text);
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 20px 30px;
            background: white;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 500;
            box-shadow: var(--card-shadow);
            transition: var(--transition);
            border: 2px solid transparent;
            text-align: center;
            flex: 1;
            max-width: 400px;
            min-width: 300px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .tab:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
        }
        
        .tab.active {
            border-color: var(--primary-color);
            background: var(--primary-color);
            color: white;
        }
        
        .tab-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }
        
        .tab-title {
            font-size: 1.4rem;
            margin-bottom: 10px;
        }
        
        .content-area {
            display: flex;
            gap: 30px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .function-panel {
            flex: 1;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: var(--card-shadow);
            min-width: 500px;
        }
        
        .function-title {
            font-size: 1.6rem;
            color: var(--secondary-color);
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light-bg);
            display: flex;
            align-items: center;
        }
        
        .function-icon {
            margin-right: 15px;
            font-size: 2rem;
        }
        
        .upload-options {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .upload-option {
            flex: 1;
            min-width: 200px;
        }
        
        .upload-area {
            border: 2px dashed var(--primary-color);
            border-radius: 10px;
            padding: 25px;
            text-align: center;
            margin-bottom: 20px;
            background: var(--light-bg);
            transition: var(--transition);
            cursor: pointer;
        }
        
        .upload-area:hover {
            background: #dfe6e9;
            transform: translateY(-3px);
        }
        
        .upload-icon {
            font-size: 3.5rem;
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        
        .btn {
            display: inline-block;
            padding: 14px 28px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 500;
            transition: var(--transition);
            margin: 10px 5px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .btn:hover {
            background: #2980b9;
            transform: translateY(-3px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }
        
        .btn i {
            margin-right: 8px;
        }
        
        .btn-process {
            background: var(--success-color);
            padding: 16px 32px;
            font-size: 1.2rem;
        }
        
        .btn-process:hover {
            background: #27ae60;
        }
        
        .btn-clear {
            background: var(--light-text);
        }
        
        .btn-clear:hover {
            background: #636e72;
        }
        
        .btn-download {
            background: var(--warning-color);
        }
        
        .btn-download:hover {
            background: #e67e22;
        }
        
        .file-list {
            margin: 20px 0;
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: #fafafa;
        }
        
        .file-item {
            padding: 12px 15px;
            background: white;
            border-radius: 6px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: var(--transition);
        }
        
        .file-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .file-name {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding-right: 10px;
        }
        
        .file-size {
            color: var(--light-text);
            font-size: 0.9rem;
            background: #f1f2f6;
            padding: 3px 8px;
            border-radius: 10px;
        }
        
        .preview-area {
            margin-top: 30px;
        }
        
        .preview-title {
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: var(--secondary-color);
            display: flex;
            align-items: center;
        }
        
        .preview-title i {
            margin-right: 10px;
        }
        
        .image-preview {
            max-width: 100%;
            max-height: 300px;
            border-radius: 10px;
            border: 1px solid #ddd;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        
        .text-output {
            width: 100%;
            height: 200px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-family: monospace;
            resize: vertical;
            background: #f8f9fa;
            font-size: 0.9rem;
            line-height: 1.5;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 25px;
            flex-wrap: wrap;
        }
        
        .instructions {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: var(--card-shadow);
            margin-top: 40px;
        }
        
        .instructions h2 {
            color: var(--secondary-color);
            margin-bottom: 20px;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
        }
        
        .instructions h2 i {
            margin-right: 10px;
        }
        
        .step {
            display: flex;
            margin-bottom: 20px;
            align-items: flex-start;
        }
        
        .step-number {
            background: var(--primary-color);
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 20px;
            flex-shrink: 0;
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        .step-content {
            flex: 1;
        }
        
        .step-content h3 {
            margin-bottom: 8px;
            color: var(--secondary-color);
        }
        
        .hidden {
            display: none;
        }
        
        .folder-info {
            margin-top: 15px;
            padding: 12px;
            background: #e8f4fc;
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
        }
        
        .progress-bar {
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin: 15px 0;
        }
        
        .progress {
            height: 100%;
            background: var(--primary-color);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .status-text {
            text-align: center;
            color: var(--light-text);
            font-size: 0.9rem;
        }
        
        @media (max-width: 1100px) {
            .content-area {
                flex-direction: column;
            }
            
            .function-panel {
                min-width: 100%;
            }
        }
        
        @media (max-width: 768px) {
            .tabs {
                flex-direction: column;
                align-items: center;
            }
            
            .tab {
                width: 100%;
                max-width: 100%;
            }
            
            .upload-options {
                flex-direction: column;
            }
            
            .upload-option {
                width: 100%;
            }
            
            .action-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 100%;
                margin: 5px 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Base64 圖片轉換工具 <span class="version">v2.0</span></h1>
            <p class="subtitle">強大且易用的圖片與Base64編碼互轉工具</p>
            <p class="tool-description">支持資料夾批量處理、自動前綴檢測、多格式轉換，讓您的圖片處理工作更加高效</p>
        </header>
        
        <div class="tabs">
            <div class="tab active" data-tab="image-to-base64">
                <div class="tab-icon"><i class="fas fa-image"></i></div>
                <div class="tab-title">圖片轉Base64</div>
                <p>將圖片文件轉換為Base64編碼</p>
            </div>
            <div class="tab" data-tab="base64-to-image">
                <div class="tab-icon"><i class="fas fa-code"></i></div>
                <div class="tab-title">Base64轉圖片</div>
                <p>將Base64編碼還原為圖片</p>
            </div>
        </div>
        
        <div class="content-area">
            <!-- 圖片轉Base64面板 -->
            <div class="function-panel" id="image-to-base64-panel">
                <div class="function-title">
                    <i class="function-icon fas fa-image"></i>
                    圖片轉Base64編碼
                </div>
                
                <div class="upload-options">
                    <div class="upload-option">
                        <div class="upload-area" onclick="document.getElementById('image-upload').click()">
                            <div class="upload-icon"><i class="fas fa-file-image"></i></div>
                            <h3>選擇圖片文件</h3>
                            <p>支持 JPG, PNG, GIF, WEBP 格式</p>
                            <input type="file" id="image-upload" accept="image/*" multiple class="hidden">
                        </div>
                    </div>
                    
                    <div class="upload-option">
                        <div class="upload-area" onclick="document.getElementById('image-folder-upload').click()">
                            <div class="upload-icon"><i class="fas fa-folder"></i></div>
                            <h3>選擇圖片資料夾</h3>
                            <p>批量處理資料夾內所有圖片</p>
                            <input type="file" id="image-folder-upload" webkitdirectory class="hidden">
                        </div>
                    </div>
                </div>
                
                <div class="file-list" id="image-file-list">
                    <div class="file-item">
                        <span class="file-name">尚未選擇文件</span>
                        <span class="file-size">-</span>
                    </div>
                </div>
                
                <div class="folder-info" id="image-folder-info" style="display: none;">
                    <i class="fas fa-info-circle"></i> 已選擇資料夾：<span id="image-folder-name">未選擇</span>，包含 <span id="image-file-count">0</span> 個圖片文件
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-process" onclick="processImageToBase64()">
                        <i class="fas fa-cog"></i> 轉換為Base64
                    </button>
                    <button class="btn btn-clear" onclick="clearImageFiles()">
                        <i class="fas fa-trash"></i> 清除
                    </button>
                </div>
                
                <div class="progress-bar" id="image-progress-bar" style="display: none;">
                    <div class="progress" id="image-progress"></div>
                </div>
                <div class="status-text" id="image-status">準備就緒</div>
                
                <div class="preview-area">
                    <h3 class="preview-title"><i class="fas fa-file-code"></i> Base64編碼結果</h3>
                    <textarea class="text-output" id="base64-output" placeholder="Base64編碼將顯示在這裡..." readonly></textarea>
                    
                    <div class="action-buttons">
                        <button class="btn" onclick="copyBase64()">
                            <i class="fas fa-copy"></i> 複製到剪貼板
                        </button>
                        <button class="btn btn-download" onclick="downloadBase64()">
                            <i class="fas fa-download"></i> 下載為文本文件
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Base64轉圖片面板 -->
            <div class="function-panel hidden" id="base64-to-image-panel">
                <div class="function-title">
                    <i class="function-icon fas fa-code"></i>
                    Base64編碼轉圖片
                </div>
                
                <div class="upload-options">
                    <div class="upload-option">
                        <div class="upload-area" onclick="document.getElementById('base64-upload').click()">
                            <div class="upload-icon"><i class="fas fa-file-alt"></i></div>
                            <h3>選擇Base64文件</h3>
                            <p>支持 .txt 文本文件</p>
                            <input type="file" id="base64-upload" accept=".txt" multiple class="hidden">
                        </div>
                    </div>
                    
                    <div class="upload-option">
                        <div class="upload-area" onclick="document.getElementById('base64-folder-upload').click()">
                            <div class="upload-icon"><i class="fas fa-folder"></i></div>
                            <h3>選擇Base64資料夾</h3>
                            <p>批量處理資料夾內所有Base64文件</p>
                            <input type="file" id="base64-folder-upload" webkitdirectory class="hidden">
                        </div>
                    </div>
                </div>
                
                <div class="file-list" id="base64-file-list">
                    <div class="file-item">
                        <span class="file-name">尚未選擇文件</span>
                        <span class="file-size">-</span>
                    </div>
                </div>
                
                <div class="folder-info" id="base64-folder-info" style="display: none;">
                    <i class="fas fa-info-circle"></i> 已選擇資料夾：<span id="base64-folder-name">未選擇</span>，包含 <span id="base64-file-count">0</span> 個文本文件
                </div>
                
                <div class="input-area">
                    <h3 class="preview-title"><i class="fas fa-pencil-alt"></i> 或直接貼上Base64編碼</h3>
                    <textarea class="text-output" id="base64-input" placeholder="在此貼上Base64編碼（支持帶或不帶前綴）..."></textarea>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-process" onclick="processBase64ToImage()">
                        <i class="fas fa-cog"></i> 轉換為圖片
                    </button>
                    <button class="btn btn-clear" onclick="clearBase64()">
                        <i class="fas fa-trash"></i> 清除
                    </button>
                </div>
                
                <div class="progress-bar" id="base64-progress-bar" style="display: none;">
                    <div class="progress" id="base64-progress"></div>
                </div>
                <div class="status-text" id="base64-status">準備就緒</div>
                
                <div class="preview-area">
                    <h3 class="preview-title"><i class="fas fa-image"></i> 圖片預覽</h3>
                    <img id="image-preview" class="image-preview" src="" alt="圖片預覽">
                    
                    <div class="action-buttons">
                        <button class="btn btn-download" onclick="downloadImage()">
                            <i class="fas fa-download"></i> 下載圖片
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="instructions">
            <h2><i class="fas fa-info-circle"></i> 使用說明</h2>
            
            <div class="step">
                <div class="step-number">1</div>
                <div class="step-content">
                    <h3>選擇轉換方向</h3>
                    <p>點擊上方標籤頁選擇要進行的轉換方向：圖片轉Base64或Base64轉圖片</p>
                </div>
            </div>
            
            <div class="step">
                <div class="step-number">2</div>
                <div class="step-content">
                    <h3>上傳文件或輸入內容</h3>
                    <p>根據選擇的功能，上傳圖片文件/資料夾或Base64文本文件/資料夾，或者直接輸入Base64編碼</p>
                    <p><strong>注意：</strong> Base64編碼可以帶有前綴（如data:image/png;base64,）或不帶前綴，系統會自動檢測並補全</p>
                </div>
            </div>
            
            <div class="step">
                <div class="step-number">3</div>
                <div class="step-content">
                    <h3>執行轉換</h3>
                    <p>點擊轉換按鈕，系統將立即處理您的請求。對於大量文件，系統會顯示進度條</p>
                </div>
            </div>
            
            <div class="step">
                <div class="step-number">4</div>
                <div class="step-content">
                    <h3>獲取結果</h3>
                    <p>轉換完成後，您可以複製結果或下載生成的文件</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局變量
        let imageFiles = [];
        let base64Files = [];
        let currentBase64Result = '';
        let currentImageResult = '';

        // 切換功能標籤
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                // 移除所有活動標籤
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                // 添加當前活動標籤
                tab.classList.add('active');
                
                // 隱藏所有面板
                document.querySelectorAll('.function-panel').forEach(panel => {
                    panel.classList.add('hidden');
                });
                
                // 顯示選中的面板
                const panelId = `${tab.dataset.tab}-panel`;
                document.getElementById(panelId).classList.remove('hidden');
            });
        });
        
        // 圖片上傳處理
        document.getElementById('image-upload').addEventListener('change', function(e) {
            handleImageFiles(e.target.files);
        });
        
        // 圖片資料夾上傳處理
        document.getElementById('image-folder-upload').addEventListener('change', function(e) {
            const files = Array.from(e.target.files).filter(file => 
                file.type.startsWith('image/') || 
                ['jpg', 'jpeg', 'png', 'gif', 'webp'].some(ext => file.name.toLowerCase().endsWith('.' + ext))
            );
            
            if (files.length > 0) {
                document.getElementById('image-folder-info').style.display = 'block';
                document.getElementById('image-folder-name').textContent = files[0].webkitRelativePath.split('/')[0];
                document.getElementById('image-file-count').textContent = files.length;
            }
            
            handleImageFiles(files);
        });
        
        // 處理圖片文件
        function handleImageFiles(files) {
            if (!files || files.length === 0) return;
            
            imageFiles = Array.from(files);
            const fileList = document.getElementById('image-file-list');
            
            fileList.innerHTML = '';
            imageFiles.forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <span class="file-name">${file.name}</span>
                    <span class="file-size">${formatFileSize(file.size)}</span>
                `;
                fileList.appendChild(fileItem);
            });
            
            document.getElementById('image-status').textContent = `已選擇 ${imageFiles.length} 個文件，點擊轉換按鈕開始處理`;
        }
        
        // Base64文件上傳處理
        document.getElementById('base64-upload').addEventListener('change', function(e) {
            handleBase64Files(e.target.files);
        });
        
        // Base64資料夾上傳處理
        document.getElementById('base64-folder-upload').addEventListener('change', function(e) {
            const files = Array.from(e.target.files).filter(file => 
                file.type === 'text/plain' || file.name.toLowerCase().endsWith('.txt')
            );
            
            if (files.length > 0) {
                document.getElementById('base64-folder-info').style.display = 'block';
                document.getElementById('base64-folder-name').textContent = files[0].webkitRelativePath.split('/')[0];
                document.getElementById('base64-file-count').textContent = files.length;
            }
            
            handleBase64Files(files);
        });
        
        // 處理Base64文件
        function handleBase64Files(files) {
            if (!files || files.length === 0) return;
            
            base64Files = Array.from(files);
            const fileList = document.getElementById('base64-file-list');
            
            fileList.innerHTML = '';
            base64Files.forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <span class="file-name">${file.name}</span>
                    <span class="file-size">${formatFileSize(file.size)}</span>
                `;
                fileList.appendChild(fileItem);
            });
            
            document.getElementById('base64-status').textContent = `已選擇 ${base64Files.length} 個文件，點擊轉換按鈕開始處理`;
        }
        
        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
            else return (bytes / 1048576).toFixed(1) + ' MB';
        }
        
        // 圖片轉Base64
        function processImageToBase64() {
            if (imageFiles.length === 0) {
                alert('請先選擇圖片文件！');
                return;
            }
            
            document.getElementById('image-progress-bar').style.display = 'block';
            document.getElementById('image-status').textContent = '處理中...';
            
            let processed = 0;
            let allBase64 = '';
            
            imageFiles.forEach((file, index) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    processed++;
                    const base64 = e.target.result;
                    
                    // 如果是多文件，添加到全部結果中
                    if (imageFiles.length > 1) {
                        allBase64 += `File: ${file.name}\n`;
                        allBase64 += `${base64}\n\n`;
                    } else {
                        allBase64 = base64;
                    }
                    
                    // 更新進度
                    const progress = (processed / imageFiles.length) * 100;
                    document.getElementById('image-progress').style.width = `${progress}%`;
                    
                    if (processed === imageFiles.length) {
                        currentBase64Result = allBase64;
                        document.getElementById('base64-output').value = allBase64;
                        document.getElementById('image-status').textContent = `轉換完成！共處理 ${imageFiles.length} 個文件`;
                    }
                };
                
                // 稍延遲處理，使UI有時間更新
                setTimeout(() => {
                    reader.readAsDataURL(file);
                }, index * 100);
            });
        }
        
        // Base64轉圖片
        function processBase64ToImage() {
            const base64Input = document.getElementById('base64-input').value;
            const hasDirectInput = base64Input.trim().length > 0;
            
            if (base64Files.length === 0 && !hasDirectInput) {
                alert('請輸入或上傳Base64編碼！');
                return;
            }
            
            document.getElementById('base64-progress-bar').style.display = 'block';
            
            // 處理直接輸入的Base64
            if (hasDirectInput) {
                document.getElementById('base64-status').textContent = '處理中...';
                
                setTimeout(() => {
                    try {
                        const imageData = ensureBase64Prefix(base64Input);
                        document.getElementById('image-preview').src = imageData;
                        currentImageResult = imageData;
                        document.getElementById('base64-progress').style.width = '100%';
                        document.getElementById('base64-status').textContent = '轉換完成！';
                    } catch (e) {
                        document.getElementById('base64-status').textContent = '錯誤：無效的Base64編碼';
                        console.error(e);
                    }
                }, 100);
                
                return;
            }
            
            // 處理Base64文件
            document.getElementById('base64-status').textContent = '處理中...';
            
            let processed = 0;
            base64Files.forEach((file, index) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    processed++;
                    
                    try {
                        const base64Data = ensureBase64Prefix(e.target.result);
                        
                        // 如果是第一個文件，顯示預覽
                        if (processed === 1) {
                            document.getElementById('image-preview').src = base64Data;
                            currentImageResult = base64Data;
                        }
                        
                        // 更新進度
                        const progress = (processed / base64Files.length) * 100;
                        document.getElementById('base64-progress').style.width = `${progress}%`;
                        
                        if (processed === base64Files.length) {
                            document.getElementById('base64-status').textContent = `轉換完成！共處理 ${base64Files.length} 個文件`;
                        }
                    } catch (e) {
                        document.getElementById('base64-status').textContent = `錯誤：文件 ${file.name} 包含無效的Base64編碼`;
                        console.error(e);
                    }
                };
                
                // 稍延遲處理，使UI有時間更新
                setTimeout(() => {
                    reader.readAsText(file);
                }, index * 100);
            });
        }
        
        // 確保Base64字符串有正確的前綴
        function ensureBase64Prefix(base64Str) {
            base64Str = base64Str.trim();
            
            // 如果已經有data:image前綴，直接返回
            if (base64Str.startsWith('data:image/')) {
                return base64Str;
            }
            
            // 嘗試檢測圖像類型
            let mimeType = 'image/png';
            
            // 簡單的啟發式檢測
            if (base64Str.startsWith('/9j/') || base64Str.startsWith('UEs')) {
                mimeType = 'image/jpeg';
            } else if (base64Str.startsWith('iVBORw0KGgo')) {
                mimeType = 'image/png';
            } else if (base64Str.startsWith('R0lGODlh')) {
                mimeType = 'image/gif';
            } else if (base64Str.startsWith('UklGR')) {
                mimeType = 'image/webp';
            }
            
            return `data:${mimeType};base64,${base64Str}`;
        }
        
        // 複製Base64到剪貼板
        function copyBase64() {
            const base64Output = document.getElementById('base64-output');
            if (!base64Output.value) {
                alert('沒有可複製的內容！');
                return;
            }
            
            base64Output.select();
            document.execCommand('copy');
            alert('Base64編碼已複製到剪貼板！');
        }
        
        // 下載Base64為文本文件
        function downloadBase64() {
            if (!currentBase64Result) {
                alert('沒有可下載的內容！');
                return;
            }
            
            const blob = new Blob([currentBase64Result], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'base64-encoding.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // 下載圖片
        function downloadImage() {
            if (!currentImageResult) {
                alert('沒有可下載的圖片！');
                return;
            }
            
            const a = document.createElement('a');
            a.href = currentImageResult;
            a.download = 'decoded-image.png';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
        
        // 清除圖片文件
        function clearImageFiles() {
            document.getElementById('image-upload').value = '';
            document.getElementById('image-folder-upload').value = '';
            document.getElementById('image-file-list').innerHTML = `
                <div class="file-item">
                    <span class="file-name">尚未選擇文件</span>
                    <span class="file-size">-</span>
                </div>
            `;
            document.getElementById('base64-output').value = '';
            document.getElementById('image-folder-info').style.display = 'none';
            document.getElementById('image-progress-bar').style.display = 'none';
            document.getElementById('image-status').textContent = '準備就緒';
            imageFiles = [];
            currentBase64Result = '';
        }
        
        // 清除Base64
        function clearBase64() {
            document.getElementById('base64-upload').value = '';
            document.getElementById('base64-folder-upload').value = '';
            document.getElementById('base64-file-list').innerHTML = `
                <div class="file-item">
                    <span class="file-name">尚未選擇文件</span>
                    <span class="file-size">-</span>
                </div>
            `;
            document.getElementById('base64-input').value = '';
            document.getElementById('image-preview').src = '';
            document.getElementById('base64-folder-info').style.display = 'none';
            document.getElementById('base64-progress-bar').style.display = 'none';
            document.getElementById('base64-status').textContent = '準備就緒';
            base64Files = [];
            currentImageResult = '';
        }
    </script>
</body>
</html>
